<html>

<head>
	<title>OpenEvse WiFi Gateway Upgrade</title>

</head>

<body>
	<h2>Firmware Upgrade</h2>
	<form id="fwupd" method="post">
		<input type="file" id="firmware" name="firmware">
		<input type="submit" value="Update">
		<br><progress id="progressBar" value="0" max="100" style="width:300px;"></progress>
		<h3 id="status"></h3>
		<p id="loaded_n_total"></p>
	</form>

	<script type="text/javascript">
		function _(el) {
			return document.getElementById(el);
		};

		_("fwupd").addEventListener("submit", uploadFile, true);


		function uploadFile(e) {
			e.preventDefault();
			var file = _("firmware").files[0];
			var formdata = new FormData();
			formdata.append("firmware", file);
			var ajax = new XMLHttpRequest();
			ajax.upload.addEventListener("progress", progressHandler, false);
			ajax.addEventListener("load", completeHandler, false);
			ajax.addEventListener("error", errorHandler, false);
			ajax.addEventListener("abort", abortHandler, false);
			ajax.onloadend = function () {
				if (ajax.status == 404)
					errorHandler();
			}
			ajax.open("POST", "/update");
			ajax.setRequestHeader("content-type", "multipart/form-data");
			ajax.send(formdata);
		};

		function progressHandler(event) {
			_("loaded_n_total").innerHTML = "Uploaded " + event.loaded + " bytes of " + event.total;
			var percent = (event.loaded / event.total) * 100;
			_("progressBar").value = Math.round(percent);
			_("status").innerHTML = Math.round(percent) + "&#37; uploaded... please wait";
		};

		function completeHandler(event) {
			_("status").innerHTML = event.target.responseText;
			_("progressBar").value = 0; //will clear progress bar after successful upload
		};

		function errorHandler(event) {
			_("status").innerHTML = "Upload Failed";
		};

		function abortHandler(event) {
			_("status").innerHTML = "Upload Aborted";
		};
	</script>
</body>

</html>